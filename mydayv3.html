<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Day</title>
    <style>
        /* Minimal CSS - only for essential functionality */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            padding: 20px;
        }

        .date-selector {
            margin-bottom: 30px;
            padding: 15px;
            background: #f5f5f5;
            border-radius: 4px;
        }

        .date-controls {
            display: flex;
            gap: 10px;
            align-items: center;
            flex-wrap: wrap;
        }

        .date-selector label {
            margin-right: 10px;
            font-weight: 600;
        }

        .date-selector input[type="date"] {
            padding: 8px 12px;
            font-size: 16px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }

        .nav-btn {
            padding: 8px 16px;
            font-size: 14px;
            border: 1px solid #ddd;
            border-radius: 4px;
            background: white;
            cursor: pointer;
        }

        .nav-btn:hover {
            background: #e9e9e9;
        }

        .nav-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .current-date-display {
            margin-top: 10px;
            font-size: 14px;
            color: #666;
        }

        /* Week navigation */
        .week-navigation {
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid #ddd;
        }

        .week-dates {
            display: flex;
            gap: 8px;
            overflow-x: auto;
            padding: 10px 0;
        }

        .date-item {
            flex-shrink: 0;
            min-width: 70px;
            padding: 10px;
            text-align: center;
            border: 2px solid #ddd;
            border-radius: 6px;
            background: white;
            cursor: pointer;
            transition: all 0.2s;
        }

        .date-item:hover {
            border-color: #999;
            background: #f9f9f9;
        }

        .date-item.active {
            border-color: #4CAF50;
            background: #e8f5e9;
            font-weight: 600;
        }

        .date-item.today {
            border-color: #2196F3;
        }

        .date-item.active.today {
            border-color: #4CAF50;
            background: #e8f5e9;
        }

        .date-day {
            font-size: 11px;
            color: #666;
            text-transform: uppercase;
        }

        .date-number {
            font-size: 18px;
            font-weight: 600;
            margin: 4px 0;
        }

        .date-month {
            font-size: 11px;
            color: #666;
        }

        .tracker-item {
            margin-bottom: 20px;
            padding-bottom: 20px;
            border-bottom: 1px solid #ddd;
        }

        .tracker-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .tracker-title {
            font-size: 1.2em;
            font-weight: 600;
        }

        .tracker-type-badge {
            display: inline-block;
            padding: 3px 8px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 600;
            background: #e0e0e0;
            margin-left: 10px;
        }

        .tracker-input {
            width: 100%;
            padding: 10px;
            font-size: 16px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }

        textarea.tracker-input {
            min-height: 80px;
            resize: vertical;
        }

        .yesno-buttons {
            display: flex;
            gap: 10px;
        }

        .yesno-btn {
            flex: 1;
            padding: 12px;
            font-size: 16px;
            border: 2px solid #ddd;
            border-radius: 4px;
            background: white;
            cursor: pointer;
            font-weight: 600;
        }

        .yesno-btn.selected-yes {
            background: #4CAF50;
            color: white;
            border-color: #4CAF50;
        }

        .yesno-btn.selected-no {
            background: #f44336;
            color: white;
            border-color: #f44336;
        }

        .numeric-input-group {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .numeric-prefix, .numeric-suffix {
            font-size: 16px;
            font-weight: 600;
            color: #666;
        }

        .numeric-input {
            flex: 1;
            padding: 10px;
            font-size: 16px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }

        .empty-state {
            text-align: center;
            padding: 40px 20px;
        }

        .save-button-container {
            position: sticky;
            bottom: 0;
            background: white;
            padding: 20px;
            border-top: 2px solid #ddd;
            text-align: center;
            margin-top: 30px;
        }

        .btn-save {
            padding: 15px 40px;
            font-size: 18px;
            font-weight: 600;
            background: #4CAF50;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }

        .btn-save:hover {
            background: #45a049;
        }

        .save-status {
            margin-top: 10px;
            font-size: 14px;
            color: #666;
        }

        .save-status.success {
            color: #4CAF50;
        }
    </style>
</head>
<body>
    <h1>My Day</h1>
    
    <div class="date-selector">
        <div class="date-controls">
            <button class="nav-btn" onclick="goToPreviousDay()">‚Üê Previous Day</button>
            <button class="nav-btn" onclick="goToToday()" id="todayBtn">Today</button>
            <label for="dateInput">Select Date:</label>
            <input type="date" id="dateInput" onchange="changeDate()">
        </div>
        <div class="current-date-display" id="currentDateDisplay"></div>
        
        <div class="week-navigation">
            <div class="week-dates" id="weekDates"></div>
        </div>
    </div>
    
    <div id="trackerList"></div>

    <div class="save-button-container">
        <button class="btn-save" onclick="saveAllTrackers()">üíæ Save Today's Entries</button>
        <div class="save-status" id="saveStatus"></div>
    </div>

    <script>
        // IndexedDB Setup
        let db;
        const DB_NAME = 'TrackerDB';
        const STORE_NAME = 'trackers';
        let currentDate = new Date().toISOString().split('T')[0]; // Current selected date
        
        // Temporary storage for current edits (before save)
        let tempSelections = {};

        // Initialize IndexedDB
        function initDB() {
            const request = indexedDB.open(DB_NAME, 2); // Match version from tracker-manager

            request.onerror = () => {
                console.error('Database failed to open');
            };

            request.onsuccess = () => {
                db = request.result;
                initializeDatePicker();
                loadTrackers();
            };

            request.onupgradeneeded = (e) => {
                db = e.target.result;
                
                if (!db.objectStoreNames.contains(STORE_NAME)) {
                    const objectStore = db.createObjectStore(STORE_NAME, { keyPath: 'id', autoIncrement: true });
                    objectStore.createIndex('title', 'title', { unique: false });
                }
            };
        }

        // Initialize date picker with current date and max date restriction
        function initializeDatePicker() {
            const dateInput = document.getElementById('dateInput');
            const today = new Date().toISOString().split('T')[0];
            
            // Set default value to today
            dateInput.value = currentDate;
            
            // Set max date to today (prevent future dates)
            dateInput.max = today;
            
            // Update display
            updateDateDisplay();
            renderWeekNavigation();
        }

        // Render week navigation with past 7 days
        function renderWeekNavigation() {
            const weekDates = document.getElementById('weekDates');
            const today = new Date();
            const dates = [];
            
            // Generate last 7 days (including today)
            for (let i = 6; i >= 0; i--) {
                const date = new Date(today);
                date.setDate(date.getDate() - i);
                dates.push(date);
            }
            
            weekDates.innerHTML = dates.map(date => {
                const dateStr = date.toISOString().split('T')[0];
                const dayName = date.toLocaleDateString('en-US', { weekday: 'short' });
                const dayNumber = date.getDate();
                const monthName = date.toLocaleDateString('en-US', { month: 'short' });
                const todayStr = new Date().toISOString().split('T')[0];
                
                const isActive = dateStr === currentDate;
                const isToday = dateStr === todayStr;
                
                let classes = 'date-item';
                if (isActive) classes += ' active';
                if (isToday) classes += ' today';
                
                return `
                    <div class="${classes}" onclick="selectWeekDate('${dateStr}')">
                        <div class="date-day">${dayName}</div>
                        <div class="date-number">${dayNumber}</div>
                        <div class="date-month">${monthName}</div>
                    </div>
                `;
            }).join('');
        }

        // Select date from week navigation
        function selectWeekDate(dateStr) {
            currentDate = dateStr;
            document.getElementById('dateInput').value = currentDate;
            updateDateDisplay();
            renderWeekNavigation();
            loadSelectionsForDate();
        }

        // Update the date display text
        function updateDateDisplay() {
            const dateObj = new Date(currentDate + 'T00:00:00');
            const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
            const formattedDate = dateObj.toLocaleDateString('en-US', options);
            
            const today = new Date().toISOString().split('T')[0];
            let displayText = formattedDate;
            
            if (currentDate === today) {
                displayText += ' (Today)';
            } else {
                const diffTime = new Date(today) - new Date(currentDate);
                const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                displayText += ` (${diffDays} day${diffDays !== 1 ? 's' : ''} ago)`;
            }
            
            document.getElementById('currentDateDisplay').textContent = displayText;
            
            // Update Today button state
            updateTodayButtonState();
            
            // Update week navigation highlight
            renderWeekNavigation();
        }

        // Update Today button state (disable if already on today)
        function updateTodayButtonState() {
            const todayBtn = document.getElementById('todayBtn');
            const today = new Date().toISOString().split('T')[0];
            
            if (currentDate === today) {
                todayBtn.disabled = true;
            } else {
                todayBtn.disabled = false;
            }
        }

        // Go to previous day
        function goToPreviousDay() {
            const dateObj = new Date(currentDate + 'T00:00:00');
            dateObj.setDate(dateObj.getDate() - 1);
            
            const previousDate = dateObj.toISOString().split('T')[0];
            currentDate = previousDate;
            
            // Update date input
            document.getElementById('dateInput').value = currentDate;
            
            updateDateDisplay();
            loadSelectionsForDate();
        }

        // Go to today
        function goToToday() {
            const today = new Date().toISOString().split('T')[0];
            currentDate = today;
            
            // Update date input
            document.getElementById('dateInput').value = currentDate;
            
            updateDateDisplay();
            loadSelectionsForDate();
        }

        // Handle date change
        function changeDate() {
            const dateInput = document.getElementById('dateInput');
            const selectedDate = dateInput.value;
            
            if (!selectedDate) return;
            
            // Validate that selected date is not in the future
            const today = new Date().toISOString().split('T')[0];
            if (selectedDate > today) {
                alert('Cannot select future dates');
                dateInput.value = currentDate;
                return;
            }
            
            currentDate = selectedDate;
            updateDateDisplay();
            loadSelectionsForDate();
        }

        // Get all trackers from DB
        function getAllTrackers() {
            return new Promise((resolve, reject) => {
                const transaction = db.transaction([STORE_NAME], 'readonly');
                const objectStore = transaction.objectStore(STORE_NAME);
                const request = objectStore.getAll();

                request.onsuccess = () => resolve(request.result);
                request.onerror = () => reject(request.error);
            });
        }

        // Get type label
        function getTypeLabel(type) {
            const labels = {
                'dropdown': 'Dropdown',
                'yesno': 'Yes/No',
                'numeric': 'Numeric',
                'text': 'Text'
            };
            return labels[type] || 'Dropdown';
        }

        // Load and display trackers
        async function loadTrackers() {
            const trackers = await getAllTrackers();
            const trackerList = document.getElementById('trackerList');

            if (trackers.length === 0) {
                trackerList.innerHTML = `
                    <div class="empty-state">
                        <p>No trackers available. Please create trackers first.</p>
                    </div>
                `;
                return;
            }

            trackerList.innerHTML = trackers.map(tracker => {
                const type = tracker.type || 'dropdown';
                return `
                    <div class="tracker-item">
                        <div class="tracker-header">
                            <div>
                                <span class="tracker-title">${tracker.title}</span>
                                <span class="tracker-type-badge">${getTypeLabel(type)}</span>
                            </div>
                        </div>
                        ${renderTrackerInput(tracker)}
                    </div>
                `;
            }).join('');

            // Load selections for current date
            loadSelectionsForDate();
        }

        // Render appropriate input based on tracker type
        function renderTrackerInput(tracker) {
            const type = tracker.type || 'dropdown';
            
            switch(type) {
                case 'dropdown':
                    return `
                        <select id="tracker-${tracker.id}" class="tracker-input" data-tracker-id="${tracker.id}" data-type="${type}">
                            <option value="">Select an option</option>
                            ${tracker.options.map((option, index) => `
                                <option value="${index}" data-color="${option.color}">
                                    ${option.title}
                                </option>
                            `).join('')}
                        </select>
                    `;
                
                case 'yesno':
                    return `
                        <div class="yesno-buttons">
                            <button class="yesno-btn" id="tracker-${tracker.id}-yes" onclick="handleYesNoChange(${tracker.id}, 'yes')">
                                Yes
                            </button>
                            <button class="yesno-btn" id="tracker-${tracker.id}-no" onclick="handleYesNoChange(${tracker.id}, 'no')">
                                No
                            </button>
                        </div>
                    `;
                
                case 'numeric':
                    const prefix = tracker.numericPrefix || '';
                    const suffix = tracker.numericSuffix || '';
                    return `
                        <div class="numeric-input-group">
                            ${prefix ? `<span class="numeric-prefix">${prefix}</span>` : ''}
                            <input 
                                type="number" 
                                id="tracker-${tracker.id}" 
                                class="numeric-input" 
                                placeholder="Enter number"
                                step="any"
                                data-tracker-id="${tracker.id}" 
                                data-type="${type}"
                            >
                            ${suffix ? `<span class="numeric-suffix">${suffix}</span>` : ''}
                        </div>
                    `;
                
                case 'text':
                    return `
                        <textarea 
                            id="tracker-${tracker.id}" 
                            class="tracker-input" 
                            placeholder="Write your note here..."
                            data-tracker-id="${tracker.id}" 
                            data-type="${type}"
                        ></textarea>
                    `;
                
                default:
                    return '<p>Unknown tracker type</p>';
            }
        }

        // Handle yes/no button click
        function handleYesNoChange(trackerId, value) {
            const yesBtn = document.getElementById(`tracker-${trackerId}-yes`);
            const noBtn = document.getElementById(`tracker-${trackerId}-no`);
            
            // Remove all selected classes
            yesBtn.classList.remove('selected-yes', 'selected-no');
            noBtn.classList.remove('selected-yes', 'selected-no');
            
            // Add appropriate class
            if (value === 'yes') {
                yesBtn.classList.add('selected-yes');
            } else {
                noBtn.classList.add('selected-no');
            }
            
            // Store temporarily (don't save yet)
            if (!tempSelections[currentDate]) {
                tempSelections[currentDate] = {};
            }
            tempSelections[currentDate][trackerId] = {
                trackerId: trackerId,
                value: value,
                type: 'yesno',
                date: currentDate
            };
        }

        // Save all trackers for the current date
        function saveAllTrackers() {
            // Collect all current values from inputs
            const currentSelections = {};
            
            // Get all dropdown values
            document.querySelectorAll('select[data-tracker-id]').forEach(select => {
                const trackerId = select.getAttribute('data-tracker-id');
                const value = select.value;
                const type = select.getAttribute('data-type');
                
                if (value) {
                    currentSelections[trackerId] = {
                        trackerId: parseInt(trackerId),
                        value: value,
                        type: type,
                        date: currentDate,
                        timestamp: new Date().toISOString()
                    };
                }
            });
            
            // Get all numeric and text inputs
            document.querySelectorAll('input[data-tracker-id], textarea[data-tracker-id]').forEach(input => {
                const trackerId = input.getAttribute('data-tracker-id');
                const value = input.value.trim();
                const type = input.getAttribute('data-type');
                
                if (value) {
                    currentSelections[trackerId] = {
                        trackerId: parseInt(trackerId),
                        value: value,
                        type: type,
                        date: currentDate,
                        timestamp: new Date().toISOString()
                    };
                }
            });
            
            // Merge with yes/no selections from tempSelections
            if (tempSelections[currentDate]) {
                Object.keys(tempSelections[currentDate]).forEach(trackerId => {
                    const selection = tempSelections[currentDate][trackerId];
                    selection.timestamp = new Date().toISOString();
                    currentSelections[trackerId] = selection;
                });
            }
            
            // Save to localStorage
            let dailySelections = JSON.parse(localStorage.getItem('dailySelections') || '{}');
            
            if (Object.keys(currentSelections).length > 0) {
                dailySelections[currentDate] = currentSelections;
            } else {
                // If no selections, remove this date
                delete dailySelections[currentDate];
            }
            
            localStorage.setItem('dailySelections', JSON.stringify(dailySelections));
            
            // Clear temp selections for this date
            if (tempSelections[currentDate]) {
                delete tempSelections[currentDate];
            }
            
            // Show success message
            const statusEl = document.getElementById('saveStatus');
            statusEl.textContent = '‚úì Saved successfully!';
            statusEl.className = 'save-status success';
            
            setTimeout(() => {
                statusEl.textContent = '';
                statusEl.className = 'save-status';
            }, 3000);
            
            console.log('Saved selections for', currentDate, currentSelections);
        }

        // Load selections for the currently selected date
        function loadSelectionsForDate() {
            const dailySelections = JSON.parse(localStorage.getItem('dailySelections') || '{}');
            const dateSelections = dailySelections[currentDate] || {};

            // Clear temp selections when changing dates
            tempSelections = {};

            // First, reset all inputs to default
            document.querySelectorAll('[id^="tracker-"]').forEach(element => {
                if (element.tagName === 'SELECT') {
                    element.value = '';
                    element.style.borderLeft = '1px solid #ddd';
                } else if (element.tagName === 'INPUT') {
                    element.value = '';
                } else if (element.tagName === 'TEXTAREA') {
                    element.value = '';
                } else if (element.classList.contains('yesno-btn')) {
                    element.classList.remove('selected-yes', 'selected-no');
                }
            });

            // Then load selections for this date
            Object.keys(dateSelections).forEach(trackerId => {
                const selection = dateSelections[trackerId];
                const type = selection.type || 'dropdown';
                
                if (type === 'dropdown') {
                    const select = document.getElementById(`tracker-${trackerId}`);
                    if (select) {
                        select.value = selection.value;
                        
                        // Apply color indicator
                        const selectedOption = select.options[select.selectedIndex];
                        const color = selectedOption.getAttribute('data-color');
                        if (color) {
                            select.style.borderLeft = `4px solid ${color}`;
                        }
                    }
                } else if (type === 'yesno') {
                    const yesBtn = document.getElementById(`tracker-${trackerId}-yes`);
                    const noBtn = document.getElementById(`tracker-${trackerId}-no`);
                    if (yesBtn && noBtn) {
                        if (selection.value === 'yes') {
                            yesBtn.classList.add('selected-yes');
                        } else {
                            noBtn.classList.add('selected-no');
                        }
                    }
                } else if (type === 'numeric' || type === 'text') {
                    const input = document.getElementById(`tracker-${trackerId}`);
                    if (input) {
                        input.value = selection.value;
                    }
                }
            });

            // Clear save status when changing dates
            const statusEl = document.getElementById('saveStatus');
            statusEl.textContent = '';
            statusEl.className = 'save-status';
        }

        // Initialize app
        initDB();
    </script>
</body>
</html>