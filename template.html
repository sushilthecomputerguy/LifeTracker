<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Manage Trackers</title>
    <style>
        * { margin:0; padding:0; box-sizing:border-box; }

           body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
             background: url('bg2.jpg');
            color:#2c3e50;
        }

        .container{
            max-width: 800px;
            display: block;
            margin:auto;
                  padding: 20px;

        }

        h1 { margin-bottom: 8px; }
        .subtitle { color: #666; font-size: 14px; margin-bottom: 24px; }

        /* â”€â”€ top actions â”€â”€ */
        .top-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
            gap: 12px;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
        }

        .btn-primary { background: #2196F3; color: white; }
        .btn-success { background: #4CAF50; color: white; }
        .btn-danger  { background: #f44336; color: white; }
        .btn:hover { opacity: 0.9; }

        /* â”€â”€ tracker list â”€â”€ */
        .tracker-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
            gap: 16px;
            margin-bottom: 30px;
        }

        .tracker-card {
            background: white;
            border-radius: 8px;
            padding: 18px;
            border: 2px solid #e0e0e0;
            position: relative;
        }

        .tracker-card:hover { border-color: #2196F3; }

        .tracker-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 12px;
        }

        .tracker-title {
            font-size: 1.1em;
            font-weight: 600;
            color: #333;
            flex: 1;
        }

        .type-badge {
            font-size: 11px;
            font-weight: 600;
            padding: 3px 8px;
            border-radius: 4px;
            background: #e8e8e8;
            color: #555;
        }

        .tracker-details {
            margin: 12px 0;
            min-height: 40px;
        }

        .option-pill {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 12px;
            color: white;
            font-weight: 600;
            margin-right: 6px;
            margin-bottom: 6px;
        }

        .tracker-meta {
            font-size: 12px;
            color: #999;
            margin-top: 8px;
        }

        .tracker-actions {
            display: flex;
            gap: 8px;
            margin-top: 12px;
            padding-top: 12px;
            border-top: 1px solid #f0f0f0;
        }

        .btn-small {
            padding: 6px 14px;
            font-size: 13px;
        }

        /* â”€â”€ empty state â”€â”€ */
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #999;
        }

        .empty-state .icon { font-size: 48px; margin-bottom: 12px; }

        /* â”€â”€ modal â”€â”€ */
        .modal {
            display: none;
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.5);
            align-items: center;
            justify-content: center;
            z-index: 1000;
            padding: 20px;
        }

        .modal.show { display: flex; }

        .modal-content {
            background: white;
            border-radius: 8px;
            padding: 24px;
            max-width: 600px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 12px;
            border-bottom: 2px solid #f0f0f0;
        }

        .modal-title {
            font-size: 1.3em;
            font-weight: 600;
        }

        .close-btn {
            background: none;
            border: none;
            font-size: 28px;
            cursor: pointer;
            color: #999;
            line-height: 1;
            padding: 0;
            width: 32px;
            height: 32px;
        }

        .close-btn:hover { color: #333; }

        /* â”€â”€ form â”€â”€ */
        .form-group {
            margin-bottom: 18px;
        }

        .form-label {
            display: block;
            font-weight: 600;
            font-size: 14px;
            color: #444;
            margin-bottom: 6px;
        }

        .form-input, .form-select {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }

        textarea.form-input {
            min-height: 60px;
            resize: vertical;
        }

        .options-section {
            background: #f8f9fa;
            padding: 14px;
            border-radius: 4px;
            margin-top: 12px;
        }

        .options-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }

        .options-header h4 {
            font-size: 14px;
            font-weight: 600;
            margin: 0;
        }

        .option-row {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
            align-items: center;
            background: white;
            padding: 8px;
            border-radius: 4px;
        }

        .option-row input[type="text"] {
            flex: 1;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }

        /* â”€â”€ COLOR PALETTE DROPDOWN â”€â”€ */
        .color-picker-wrapper {
            position: relative;
            width: 120px;
        }

        .color-display-btn {
            width: 100%;
            height: 36px;
            border: 2px solid #ddd;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 4px;
            background: white;
        }

        .color-display-btn:hover {
            border-color: #2196F3;
        }

        .color-preview {
            width: 24px;
            height: 24px;
            border-radius: 4px;
            border: 1px solid rgba(0,0,0,0.1);
        }

        .color-dropdown-arrow {
            font-size: 12px;
            color: #666;
            margin-right: 4px;
        }

        .color-palette {
            display: none;
            position: absolute;
            top: 42px;
            left: 0;
            z-index: 100;
            background: white;
            border: 2px solid #ddd;
            border-radius: 8px;
            padding: 12px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            width: 200px;
        }

        .color-palette.show {
            display: block;
        }

        .color-palette-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 8px;
        }

        .color-swatch {
            width: 40px;
            height: 40px;
            border-radius: 6px;
            cursor: pointer;
            border: 2px solid transparent;
            transition: all 0.2s ease;
            position: relative;
        }

        .color-swatch:hover {
            transform: scale(1.1);
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
        }

        .color-swatch.selected {
            border: 3px solid #2196F3;
            transform: scale(1.05);
        }

        .color-swatch.selected::after {
            content: 'âœ“';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: white;
            font-weight: bold;
            font-size: 16px;
            text-shadow: 0 1px 2px rgba(0,0,0,0.5);
        }

        .remove-option-btn {
            background: #f44336;
            color: white;
            border: none;
            width: 28px;
            height: 28px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 18px;
            line-height: 1;
            flex-shrink: 0;
        }

        .remove-option-btn:hover { background: #d32f2f; }

        .btn-outline {
            background: white;
            color: #2196F3;
            border: 1px solid #2196F3;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 13px;
            font-weight: 600;
        }

        .btn-outline:hover {
            background: #e3f2fd;
        }

        .hidden { display: none !important; }

        .numeric-config {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
        }

        /* â”€â”€ templates â”€â”€ */
        .templates-section {
            margin-bottom: 40px;
        }

        .templates-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
            gap: 12px;
        }

        .template-btn {
            background: white;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            padding: 16px 12px;
            cursor: pointer;
            text-align: center;
            font-size: 15px;
            font-weight: 600;
            color: #333;
            transition: all 0.2s;
        }

        .template-btn:hover {
            border-color: #2196F3;
            background: #f5f9ff;
        }

        .template-type {
            font-size: 11px;
            color: #999;
            font-weight: 400;
            margin-top: 6px;
        }

        /* â”€â”€ DISPLAY STYLE SELECTOR â”€â”€ */
        .display-style-group {
            margin-bottom: 16px;
            padding: 12px;
            background: #f0f4f8;
            border-radius: 6px;
        }

        .display-style-label {
            display: block;
            font-weight: 600;
            font-size: 13px;
            color: #555;
            margin-bottom: 10px;
        }

        .display-style-options {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
        }

        .display-style-option {
            flex: 1;
            min-width: 140px;
        }

        .display-style-option input[type="radio"] {
            display: none;
        }

        .display-style-option label {
            display: block;
            padding: 10px 14px;
            background: white;
            border: 2px solid #ddd;
            border-radius: 6px;
            cursor: pointer;
            text-align: center;
            font-size: 13px;
            font-weight: 600;
            color: #555;
            transition: all 0.2s ease;
        }

        .display-style-option input[type="radio"]:checked + label {
            background: #2196F3;
            border-color: #2196F3;
            color: white;
        }

        .display-style-option label:hover {
            border-color: #2196F3;
        }

        .display-style-icon {
            display: block;
            font-size: 18px;
            margin-bottom: 4px;
        }

        .display-style-hint {
            font-size: 11px;
            color: #999;
            margin-top: 8px;
            font-style: italic;
        }
    </style>
</head>
<body>

<div class="container">
    <h1>ğŸ›ï¸ Manage Trackers</h1>
    <p class="subtitle">Create custom trackers for your daily temple visits and habits</p>

    <!-- â”€â”€ Top Bar â”€â”€ -->
    <div class="top-bar">
        <button class="btn btn-primary" onclick="openAddModal()">+ Add Custom Tracker</button>
    </div>

    <!-- â”€â”€ Templates Section â”€â”€ -->
    <div class="templates-section">
        <h3 style="margin-bottom: 12px;">Quick Start Templates</h3>
        <div class="templates-grid" id="templatesGrid"></div>
    </div>

    <!-- â”€â”€ Tracker List â”€â”€ -->
    <div class="tracker-grid" id="trackerList"></div>
</div>

<!-- â”€â”€ Modal â”€â”€ -->
<div class="modal" id="trackerModal">
    <div class="modal-content">
        <div class="modal-header">
            <h2 class="modal-title" id="modalTitle">Add New Tracker</h2>
            <button class="close-btn" onclick="closeModal()">&times;</button>
        </div>

        <form id="trackerForm" onsubmit="saveTracker(event)">
            <div class="form-group">
                <label class="form-label">Tracker Name *</label>
                <input type="text" id="trackerName" class="form-input" placeholder="e.g., Temple Visit" required>
            </div>

            <div class="form-group">
                <label class="form-label">Type *</label>
                <select id="trackerType" class="form-select" onchange="handleTypeChange()">
                    <option value="dropdown">Dropdown (multiple choices)</option>
                    <option value="yesno">Yes/No</option>
                    <option value="numeric">Numeric</option>
                    <option value="text">Text</option>
                </select>
            </div>

            <!-- â”€â”€ Dropdown Options â”€â”€ -->
            <div id="dropdownSection" class="options-section">
                <!-- Display Style Selector -->
                <div class="display-style-group">
                    <span class="display-style-label">Display Style (how to show on My Day page):</span>
                    <div class="display-style-options">
                        <div class="display-style-option">
                            <input type="radio" id="displayRadio" name="displayStyle" value="radio" checked>
                            <label for="displayRadio">
                                <span class="display-style-icon">âšª</span>
                                Radio Buttons
                            </label>
                        </div>
                        <div class="display-style-option">
                            <input type="radio" id="displayDropdown" name="displayStyle" value="dropdown">
                            <label for="displayDropdown">
                                <span class="display-style-icon">â–¼</span>
                                Dropdown
                            </label>
                        </div>
                        <div class="display-style-option">
                            <input type="radio" id="displaySlider" name="displayStyle" value="slider">
                            <label for="displaySlider">
                                <span class="display-style-icon">â”â”â—â”â”</span>
                                Level Slider
                            </label>
                        </div>
                    </div>
                    <div class="display-style-hint" id="sliderHint" style="display: none;">
                        ğŸ’¡ Tip: Arrange options from low to high (e.g., Sad â†’ Happy) for best slider experience
                    </div>
                </div>

                <!-- Options List -->
                <div class="options-header">
                    <h4>Options</h4>
                    <button type="button" class="btn-outline" onclick="addOption()">+ Add Option</button>
                </div>
                <div id="optionsList"></div>
            </div>

            <!-- â”€â”€ Numeric Config â”€â”€ -->
            <div id="numericSection" class="form-group hidden">
                <label class="form-label">Numeric Format</label>
                <div class="numeric-config">
                    <div>
                        <input type="text" id="numericPrefix" class="form-input" placeholder="Prefix (e.g., $)">
                    </div>
                    <div>
                        <input type="text" id="numericSuffix" class="form-input" placeholder="Suffix (e.g., kg)">
                    </div>
                </div>
            </div>

            <div style="display: flex; gap: 10px; margin-top: 24px;">
                <button type="submit" class="btn btn-success" style="flex:1;">Save Tracker</button>
                <button type="button" class="btn btn-danger" onclick="closeModal()">Cancel</button>
            </div>
        </form>
    </div>
</div>

<script>
/* â•â•â• INDEXEDDB â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
let db;
let editingId = null;
const DB_NAME = 'TrackerDB';
const STORE_NAME = 'trackers';


function initDB() {
    const req = indexedDB.open(DB_NAME, 2);

    req.onupgradeneeded = (e) => {
        db = e.target.result;
        if (!db.objectStoreNames.contains(STORE_NAME)) {
            db.createObjectStore(STORE_NAME, { keyPath: 'id', autoIncrement: true });
        }
    };

    req.onsuccess = (e) => {
        db = e.target.result;
        loadTrackers();
        loadTemplates();
    };

    req.onerror = (e) => {
        console.error('IndexedDB error:', e);
    };
}

function getAllTrackers() {
    return new Promise((res, rej) => {
        const req = db.transaction([STORE_NAME],'readonly').objectStore(STORE_NAME).getAll();
        req.onsuccess = () => res(req.result);
        req.onerror   = () => rej(req.error);
    });
}

function addTracker(tracker) {
    return new Promise((res, rej) => {
        const req = db.transaction([STORE_NAME],'readwrite').objectStore(STORE_NAME).add(tracker);
        req.onsuccess = () => res(req.result);
        req.onerror   = () => rej(req.error);
    });
}

function updateTracker(id, tracker) {
    return new Promise((res, rej) => {
        const req = db.transaction([STORE_NAME],'readwrite').objectStore(STORE_NAME).put({...tracker, id});
        req.onsuccess = () => res();
        req.onerror   = () => rej(req.error);
    });
}

function deleteTracker(id) {
    return new Promise((res, rej) => {
        const req = db.transaction([STORE_NAME],'readwrite').objectStore(STORE_NAME).delete(id);
        req.onsuccess = () => res();
        req.onerror   = () => rej(req.error);
    });
}

/* â•â•â• COLOR PALETTE â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
const COLOR_PALETTE = [
    // Yellow shades
    '#f1c40f', '#f5d04a', '#f9dc7c', '#fcebaf',
    // Orange shades
    '#d35400', '#dc6e1a', '#e58a3d', '#efa570',
    // Red shades
    '#c0392b', '#d05446', '#de7268', '#ec9089',
    // Dark blue shades
    '#2c3e50', '#465a6f', '#61788e', '#7c95ad',
    // Purple shades
    '#8e44ad', '#a15eba', '#b479c7', '#c795d4',
    // Blue shades
    '#2980b9', '#4d96c6', '#72acd3', '#96c2e0',
    // Green shades
    '#27ae60', '#4dbe7d', '#74cd9a', '#9bddb7',
    // Teal shades
    '#16a085', '#3bb39a', '#62c5af', '#89d7c4'
];

function createColorPalette(selectedColor = '#f1c40f') {
    const wrapper = document.createElement('div');
    wrapper.className = 'color-picker-wrapper';
    
    // Create display button
    const displayBtn = document.createElement('div');
    displayBtn.className = 'color-display-btn';
    displayBtn.innerHTML = `
        <div class="color-preview" style="background-color: ${selectedColor}"></div>
        <span class="color-dropdown-arrow">â–¼</span>
    `;
    
    // Create dropdown palette
    const paletteDropdown = document.createElement('div');
    paletteDropdown.className = 'color-palette';
    
    const paletteGrid = document.createElement('div');
    paletteGrid.className = 'color-palette-grid';
    
    COLOR_PALETTE.forEach(color => {
        const swatch = document.createElement('div');
        swatch.className = 'color-swatch';
        swatch.style.backgroundColor = color;
        swatch.dataset.color = color;
        
        if (color === selectedColor) {
            swatch.classList.add('selected');
        }
        
        swatch.onclick = function(e) {
            e.stopPropagation();
            // Remove selected class from all swatches in this palette
            paletteGrid.querySelectorAll('.color-swatch').forEach(s => {
                s.classList.remove('selected');
            });
            // Add selected class to clicked swatch
            this.classList.add('selected');
            // Update the color preview
            displayBtn.querySelector('.color-preview').style.backgroundColor = color;
            // Update the selected color
            wrapper.dataset.selectedColor = color;
            // Close dropdown
            paletteDropdown.classList.remove('show');
        };
        
        paletteGrid.appendChild(swatch);
    });
    
    paletteDropdown.appendChild(paletteGrid);
    
    // Toggle dropdown on button click
    displayBtn.onclick = function(e) {
        e.stopPropagation();
        // Close all other dropdowns
        document.querySelectorAll('.color-palette.show').forEach(p => {
            if (p !== paletteDropdown) p.classList.remove('show');
        });
        paletteDropdown.classList.toggle('show');
    };
    
    wrapper.appendChild(displayBtn);
    wrapper.appendChild(paletteDropdown);
    wrapper.dataset.selectedColor = selectedColor;
    
    return wrapper;
}

// Close dropdowns when clicking outside
document.addEventListener('click', function(e) {
    if (!e.target.closest('.color-picker-wrapper')) {
        document.querySelectorAll('.color-palette.show').forEach(p => {
            p.classList.remove('show');
        });
    }
});

// Handle display style change to show/hide slider hint
document.addEventListener('DOMContentLoaded', function() {
    const radioInputs = document.querySelectorAll('input[name="displayStyle"]');
    const sliderHint = document.getElementById('sliderHint');
    
    radioInputs.forEach(input => {
        input.addEventListener('change', function() {
            if (this.value === 'slider') {
                sliderHint.style.display = 'block';
            } else {
                sliderHint.style.display = 'none';
            }
        });
    });
});

/* â•â•â• STARTER TEMPLATES â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
const TEMPLATES = [
    { title: 'Daily Mood', type: 'dropdown', options: [
        {title:'Very Happy', color:'#4CAF50'}, {title:'Happy', color:'#8BC34A'}, 
        {title:'Neutral', color:'#FFC107'}, {title:'Sad', color:'#FF9800'}, {title:'Very Sad', color:'#F44336'}
    ]},
    { title: 'Sleep Quality', type: 'dropdown', options: [
        {title:'Excellent', color:'#4CAF50'}, {title:'Good', color:'#8BC34A'},
        {title:'Fair', color:'#FFC107'}, {title:'Poor', color:'#FF9800'}, {title:'Terrible', color:'#F44336'}
    ]},
    { title: 'Exercise', type: 'dropdown', options: [
        {title:'Intense Workout', color:'#E91E63'}, {title:'Moderate Exercise', color:'#9C27B0'},
        {title:'Light Activity', color:'#673AB7'}, {title:'Stretching', color:'#3F51B5'}, {title:'No Exercise', color:'#9E9E9E'}
    ]},
    { title: 'Meditation', type: 'yesno' },
    { title: 'Weight', type: 'numeric', numericPrefix: '', numericSuffix: 'lbs' },
    { title: 'Water Intake', type: 'numeric', numericPrefix: '', numericSuffix: 'glasses' },
    { title: 'Daily Journal', type: 'text' },
    { title: 'Gratitude', type: 'text' }
];

function loadTemplates() {
    const grid = document.getElementById('templatesGrid');
    grid.innerHTML = TEMPLATES.map(t => `
        <button class="template-btn" onclick='useTemplate(${JSON.stringify(t)})'>
            ${t.title}
            <div class="template-type">${typeLabel(t.type)}</div>
        </button>
    `).join('');
}

async function useTemplate(template) {
    const tracker = {
        title: template.title,
        type: template.type,
        createdAt: new Date().toISOString()
    };
    if (template.options) {
        tracker.options = template.options;
        tracker.displayStyle = 'radio'; // Default display style for templates
    }
    if (template.numericPrefix !== undefined) tracker.numericPrefix = template.numericPrefix;
    if (template.numericSuffix !== undefined) tracker.numericSuffix = template.numericSuffix;

    await addTracker(tracker);
    loadTrackers();
}

/* â•â•â• LOAD TRACKERS â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
async function loadTrackers() {
    const trackers = await getAllTrackers();
    const list = document.getElementById('trackerList');

    if (!trackers.length) {
        list.innerHTML = `<div class="empty-state">
            <div class="icon">ğŸ“Š</div>
            <p>No trackers yet. Use a template above or add your own!</p>
        </div>`;
        return;
    }

    list.innerHTML = trackers.map(t => {
        const type = t.type || 'dropdown';
        let detailHTML = '';

        if (type === 'dropdown' && t.options) {
            detailHTML = t.options.map(o => 
                `<span class="option-pill" style="background:${o.color}">${o.title}</span>`
            ).join('');
            
            // Add display style indicator
            const displayStyle = t.displayStyle || 'radio';
            const displayIcons = {
                'radio': 'âšª Radio Buttons',
                'dropdown': 'â–¼ Dropdown',
                'slider': 'â”â”â—â”â” Slider'
            };
            detailHTML += `<div style="margin-top:8px;font-size:11px;color:#999;">Display: ${displayIcons[displayStyle]}</div>`;
            
        } else if (type === 'yesno') {
            detailHTML = '<span style="color:#666;font-size:13px;">Yes or No</span>';
        } else if (type === 'numeric') {
            const p = t.numericPrefix || '';
            const s = t.numericSuffix || '';
            detailHTML = `<span style="color:#666;font-size:13px;">Format: ${p}[number]${s ? ' '+s : ''}</span>`;
        } else {
            detailHTML = '<span style="color:#666;font-size:13px;">Free text entry</span>';
        }

        return `
            <div class="tracker-card">
                <div class="tracker-header">
                    <div class="tracker-title">${t.title}</div>
                    <div class="type-badge">${typeLabel(type)}</div>
                </div>
                <div class="tracker-details">${detailHTML}</div>
                <div class="tracker-meta">Created: ${new Date(t.createdAt).toLocaleDateString()}</div>
                <div class="tracker-actions">
                    <button class="btn btn-primary btn-small" onclick="openEditModal(${t.id})">Edit</button>
                    <button class="btn btn-danger btn-small" onclick="confirmDelete(${t.id}, '${t.title.replace(/'/g, "\\'")}')">Delete</button>
                </div>
            </div>`;
    }).join('');
}

/* â•â•â• MODAL â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function openAddModal() {
    editingId = null;
    document.getElementById('modalTitle').textContent = 'Add New Tracker';
    document.getElementById('trackerForm').reset();
    document.getElementById('trackerType').value = 'dropdown';
    document.getElementById('optionsList').innerHTML = '';
    document.getElementById('displayRadio').checked = true;
    document.getElementById('sliderHint').style.display = 'none';
    handleTypeChange();
    addOption(); // default one option
    document.getElementById('trackerModal').classList.add('show');
}

async function openEditModal(id) {
    editingId = id;
    const trackers = await getAllTrackers();
    const tracker = trackers.find(t => t.id === id);
    if (!tracker) return;

    document.getElementById('modalTitle').textContent = 'Edit Tracker';
    document.getElementById('trackerName').value = tracker.title;
    document.getElementById('trackerType').value = tracker.type || 'dropdown';

    if (tracker.type === 'numeric') {
        document.getElementById('numericPrefix').value = tracker.numericPrefix || '';
        document.getElementById('numericSuffix').value = tracker.numericSuffix || '';
    }

    handleTypeChange();

    if ((tracker.type === 'dropdown' || !tracker.type) && tracker.options) {
        document.getElementById('optionsList').innerHTML = '';
        tracker.options.forEach(o => addOption(o.title, o.color));
        
        // Set display style
        const displayStyle = tracker.displayStyle || 'radio';
        document.getElementById('display' + displayStyle.charAt(0).toUpperCase() + displayStyle.slice(1)).checked = true;
        document.getElementById('sliderHint').style.display = displayStyle === 'slider' ? 'block' : 'none';
    }

    document.getElementById('trackerModal').classList.add('show');
}

function closeModal() {
    document.getElementById('trackerModal').classList.remove('show');
    editingId = null;
}

function handleTypeChange() {
    const type = document.getElementById('trackerType').value;
    document.getElementById('dropdownSection').classList.toggle('hidden', type !== 'dropdown');
    document.getElementById('numericSection').classList.toggle('hidden', type !== 'numeric');
}

/* â•â•â• OPTIONS â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function addOption(title = '', color = '#f1c40f') {
    const list = document.getElementById('optionsList');
    const id = Date.now() + Math.random();
    const div = document.createElement('div');
    div.className = 'option-row';
    div.id = `option-${id}`;
    
    const input = document.createElement('input');
    input.type = 'text';
    input.className = 'option-title';
    input.placeholder = 'Option name';
    input.value = title;
    
    const colorPicker = createColorPalette(color);
    
    const removeBtn = document.createElement('button');
    removeBtn.type = 'button';
    removeBtn.className = 'remove-option-btn';
    removeBtn.textContent = 'Ã—';
    removeBtn.onclick = () => removeOption(id);
    
    div.appendChild(input);
    div.appendChild(colorPicker);
    div.appendChild(removeBtn);
    
    list.appendChild(div);
}

function removeOption(id) {
    document.getElementById(`option-${id}`)?.remove();
}

/* â•â•â• SAVE â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
async function saveTracker(e) {
    e.preventDefault();

    const title = document.getElementById('trackerName').value.trim();
    const type  = document.getElementById('trackerType').value;

    if (!title) return alert('Please enter a tracker name');

    const tracker = { title, type, createdAt: new Date().toISOString() };

    if (type === 'dropdown') {
        const rows = [...document.querySelectorAll('#optionsList .option-row')];
        if (!rows.length) return alert('Add at least one option');

        const options = rows.map(row => {
            const titleInput = row.querySelector('.option-title');
            const colorPicker = row.querySelector('.color-picker-wrapper');
            return {
                title: titleInput.value.trim(),
                color: colorPicker.dataset.selectedColor
            };
        });

        if (options.some(o => !o.title)) return alert('Fill in all option names');
        tracker.options = options;
        
        // Save display style
        const displayStyle = document.querySelector('input[name="displayStyle"]:checked').value;
        tracker.displayStyle = displayStyle;

    } else if (type === 'numeric') {
        tracker.numericPrefix = document.getElementById('numericPrefix').value.trim();
        tracker.numericSuffix = document.getElementById('numericSuffix').value.trim();
    }

    if (editingId) {
        await updateTracker(editingId, tracker);
    } else {
        await addTracker(tracker);
    }

    closeModal();
    loadTrackers();
}

/* â•â•â• DELETE â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
async function confirmDelete(id, title) {
    if (!confirm(`Delete "${title}"?\n\nThis will remove the tracker but keep your saved data.`)) return;
    await deleteTracker(id);
    loadTrackers();
}

/* â•â•â• UTILS â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function typeLabel(t) {
    return {dropdown:'Dropdown', yesno:'Yes/No', numeric:'Numeric', text:'Text'}[t] || 'Dropdown';
}

/* â•â•â• BOOT â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
initDB();
</script>
</body>
</html>