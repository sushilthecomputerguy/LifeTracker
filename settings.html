<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Settings</title>
    <link rel="stylesheet" href="styles.css">
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#fef5eb">
    <link rel="icon" href="favicon.ico" type="image/x-icon">
    <style>
        .btn-danger {
            background-color: #e53935;
            color: #fff;
            border: none;
            border-radius: 8px;
            padding: 10px 18px;
            font-size: 0.95rem;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.2s, opacity 0.2s;
        }
        .btn-danger:hover  { background-color: #c62828; }
        .btn-danger:active { opacity: 0.85; }
        .btn-danger:disabled { opacity: 0.55; cursor: not-allowed; }
    </style>
</head>
<body>


<div class="container">

    <h1>Settings</h1>

    <!-- â”€â”€ APPEARANCE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
    <div class="section">

        <div class="section-title">Appearance</div>

        <!-- Light / Dark -->
        <div class="form-group">
            <label class="form-label">Theme</label>
            <div class="display-style-group">
                <div class="display-style-options">
                    <div class="display-style-option">
                        <input type="radio" name="theme" id="themeLight" value="light">
                        <label for="themeLight">
                            <span class="display-style-icon">â˜€ï¸</span>
                            Light
                        </label>
                    </div>
                    <div class="display-style-option">
                        <input type="radio" name="theme" id="themeDark" value="dark">
                        <label for="themeDark">
                            <span class="display-style-icon">ğŸŒ™</span>
                            Dark
                        </label>
                    </div>

                </div>
            </div>
        </div>

        <!-- Font Size -->
        <div class="form-group">
            <label class="form-label">Font Size</label>
            <div class="slider-container">
                <div class="slider-label" id="fontSizeLabel">Medium (16px)</div>
                <div class="slider-wrapper">
                    <input
                        type="range"
                        class="slider-input"
                        id="fontSizeSlider"
                        min="1" max="5" step="1" value="3"
                        oninput="onFontSizeChange(this.value)"
                    >
                </div>
                <div class="slider-marks">
                    <span class="slider-mark">XS</span>
                    <span class="slider-mark">S</span>
                    <span class="slider-mark">M</span>
                    <span class="slider-mark">L</span>
                    <span class="slider-mark">XL</span>
                </div>
            </div>
        </div>

    </div>

    <!-- â”€â”€ LANGUAGE & REGION â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
    <div class="section">

        <div class="section-title">Language &amp; Region</div>

        <!-- Language -->
        <div class="form-group">
            <label class="form-label" for="languageSelect">Language</label>
            <select class="form-select" id="languageSelect" onchange="saveSetting('language', this.value)">
                <option value="en">ğŸ‡¬ğŸ‡§  English</option>
                <option value="es">ğŸ‡ªğŸ‡¸  EspaÃ±ol</option>
                <option value="fr">ğŸ‡«ğŸ‡·  FranÃ§ais</option>
                <option value="de">ğŸ‡©ğŸ‡ª  Deutsch</option>
                <option value="ja">ğŸ‡¯ğŸ‡µ  æ—¥æœ¬èª</option>
                <option value="zh">ğŸ‡¨ğŸ‡³  ä¸­æ–‡</option>
                <option value="pt">ğŸ‡µğŸ‡¹  PortuguÃªs</option>
                <option value="ar">ğŸ‡¸ğŸ‡¦  Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©</option>
                <option value="hi">ğŸ‡®ğŸ‡³  à¤¹à¤¿à¤¨à¥à¤¦à¥€</option>
                <option value="ne">ğŸ‡³ğŸ‡µ  à¤¨à¥‡à¤ªà¤¾à¤²à¥€</option>
            </select>
        </div>

        <!-- Timezone -->
        <div class="form-group">
            <label class="form-label" for="timezoneSelect">Timezone</label>
            <select class="form-select" id="timezoneSelect" onchange="saveSetting('timezone', this.value)">
            </select>
            <div class="section-desc" style="margin-top:8px;margin-bottom:0;" id="tzCurrentTime"></div>
        </div>

    </div>

    <!-- â”€â”€ BACKUP â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
    <div class="section">

        <div class="section-title">Backup</div>
        <div class="section-desc">Export or restore your tracker data.</div>

        <div style="margin-top:12px;">
            <a href="backup.html" class="btn btn-primary">ğŸ“¦ Open Backup Page</a>
        </div>

    </div>


    <!-- â”€â”€ BACKUP â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
    <div class="section">

        <div class="section-title">Feedback</div>
        <div class="section-desc">Weâ€™re trying hard to improve it, so your feedback would be greatly appreciated.ğŸ˜Š</div>

        <div style="margin-top:12px;">
            <a href="mailto:sushilfiles@gmail.com" class="btn btn-primary">ğŸ“§ sushilfiles@gmail.com</a>
        </div>

    </div>

    <!-- â”€â”€ PURGING â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
    <div class="section">

        <div class="section-title">Purging</div>
        <div class="section-desc">Clear cached data stored on your device.</div>

        <!-- Purge PWA Offline Cache -->
        <div class="form-group">
            <label class="form-label">PWA Offline Cache</label>
            <div class="section-desc" style="margin-bottom: 10px;">
                Removes all Service Worker cache files (scripts, styles, images, etc.).
                Your IndexedDB data will <strong>not</strong> be affected.
            </div>
            <button class="btn btn-danger" id="btnPurgeCache" onclick="purgeOfflineCache()">
                ğŸ—‘ï¸ Purge Offline Cache
            </button>
        </div>

        <!-- Purge IndexedDB -->
        <div class="form-group" style="margin-bottom: 0;">
            <label class="form-label">IndexedDB Data</label>
            <div class="section-desc" style="margin-bottom: 10px;">
                Permanently deletes all tracker and entry data stored in IndexedDB (trackers you have created and all logged entries).
                Quick Start Templates are built into the app and will still be available, but any trackers created from them will be gone.
                Export a backup first if needed.
            </div>
            <button class="btn btn-danger" id="btnPurgeIDB" onclick="purgeIndexedDB()">
                ğŸ—‘ï¸ Purge IndexedDB
            </button>
        </div>

    </div>

    <!-- â”€â”€ ABOUT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
    <div class="section">
        <div class="section-title">About</div>
        <div class="section-desc" id="aboutBlock">
            App version <strong>1.0.0</strong><br>
            Data is stored locally on your device â€” nothing is sent to a server.
        </div>

        <div class="box box-info" style="margin-top:0;">
            <div class="box-title">Your data stays on your device</div>
            All trackers and entries are stored in your browser's IndexedDB and localStorage.
            Use Backup to keep a copy safe.
        </div>
    </div>

    <!-- â”€â”€ TOAST â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
    <div class="toast" id="toast">
        <span class="toast-icon">
            <svg viewBox="0 0 24 24"><polyline points="20 6 9 17 4 12"/></svg>
        </span>
        <span id="toastMsg">Saved</span>
    </div>

</div><!-- /.container -->
<div class="bottom-navigation">
            <div><a href="trackers.html"><img src="folder-icon.svg"/>Tracker</a></div>
            <div><a href="report.html"><img src="report-icon.svg"/>Report</a></div>
            <div><a href="index.html"><img src="today-icon.svg"/>My Day</a></div>
            <div><a href="settings.html"><img src="setting-icon.svg"/>Settings</a></div>
        </div>

<script>
/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   SETTINGS  â€”  settings.html
   All preferences are persisted in localStorage under the
   key  "appSettings"  as a JSON object.
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */

const SETTINGS_KEY = 'appSettings';

/* â”€â”€ Font size map â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
const FONT_SIZES = {
    1: { label: 'X-Small (12px)', px: 12 },
    2: { label: 'Small (14px)',   px: 14 },
    3: { label: 'Medium (16px)',  px: 16 },
    4: { label: 'Large (18px)',   px: 18 },
    5: { label: 'X-Large (20px)', px: 20 },
};

/* â”€â”€ Load / save helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function loadSettings() {
    try { return JSON.parse(localStorage.getItem(SETTINGS_KEY)) || {}; }
    catch { return {}; }
}

function saveSetting(key, value) {
    const s = loadSettings();
    s[key]  = value;
    localStorage.setItem(SETTINGS_KEY, JSON.stringify(s));
    showToast('Setting saved');
}

/* â”€â”€ Toast â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
let toastTimer;
function showToast(msg) {
    const t = document.getElementById('toast');
    document.getElementById('toastMsg').textContent = msg;
    t.classList.add('show');
    clearTimeout(toastTimer);
    toastTimer = setTimeout(() => t.classList.remove('show'), 2200);
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   THEME
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function applyTheme(value) {
    if (value === 'system') {
        localStorage.removeItem('theme');
        const sys = window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light';
        document.documentElement.setAttribute('data-theme', sys);
    } else {
        localStorage.setItem('theme', value);
        document.documentElement.setAttribute('data-theme', value);
    }
    // sync floating toggle icon
    const isDark = document.documentElement.getAttribute('data-theme') === 'dark';
    document.querySelectorAll('.theme-toggle').forEach(btn => {
        btn.textContent = isDark ? 'â˜€ï¸' : 'ğŸŒ™';
        btn.setAttribute('aria-label', isDark ? 'Switch to light mode' : 'Switch to dark mode');
    });
}

function initThemeRadios() {
    const saved = localStorage.getItem('theme'); // 'light' | 'dark' | null(=system)
    const val   = saved || 'system';
    const radio = document.querySelector(`input[name="theme"][value="${val}"]`);
    if (radio) radio.checked = true;

    document.querySelectorAll('input[name="theme"]').forEach(r => {
        r.addEventListener('change', () => {
            applyTheme(r.value);
            saveSetting('theme', r.value);
        });
    });
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   FONT SIZE
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function applyFontSize(val) {
    const size = FONT_SIZES[val];
    document.getElementById('fontSizeLabel').textContent = size.label;
    document.documentElement.style.fontSize = size.px + 'px';
}

function onFontSizeChange(val) {
    applyFontSize(val);
    saveSetting('fontSize', parseInt(val));
}

function initFontSize() {
    const s   = loadSettings();
    const val = s.fontSize || 3;
    const slider = document.getElementById('fontSizeSlider');
    slider.value = val;
    applyFontSize(val);
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   LANGUAGE
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function initLanguage() {
    const s   = loadSettings();
    const sel = document.getElementById('languageSelect');
    if (s.language) sel.value = s.language;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   TIMEZONE
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function populateTimezones() {
    const zones = Intl.supportedValuesOf
        ? Intl.supportedValuesOf('timeZone')
        : [ // fallback list for older browsers
            'UTC','America/New_York','America/Chicago','America/Denver',
            'America/Los_Angeles','America/Sao_Paulo','Europe/London',
            'Europe/Paris','Europe/Berlin','Europe/Moscow',
            'Asia/Dubai','Asia/Kolkata','Asia/Kathmandu','Asia/Bangkok',
            'Asia/Shanghai','Asia/Tokyo','Australia/Sydney','Pacific/Auckland'
          ];

    const sel     = document.getElementById('timezoneSelect');
    const s       = loadSettings();
    const current = s.timezone || Intl.DateTimeFormat().resolvedOptions().timeZone;

    sel.innerHTML = zones.map(z =>
        `<option value="${z}" ${z === current ? 'selected' : ''}>${z.replace(/_/g,' ')}</option>`
    ).join('');

    updateTzClock(current);
}

function updateTzClock(tz) {
    try {
        const now = new Date().toLocaleString('en-GB', {
            timeZone: tz,
            weekday: 'short', year: 'numeric', month: 'short',
            day: 'numeric', hour: '2-digit', minute: '2-digit'
        });
        document.getElementById('tzCurrentTime').textContent = `Current time: ${now}`;
    } catch { /* ignore bad tz */ }
}

document.getElementById('timezoneSelect').addEventListener('change', function () {
    saveSetting('timezone', this.value);
    updateTzClock(this.value);
});

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   THEME TOGGLE (floating button â€” reuse existing theme.js logic)
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
(function () {
    const LIGHT = 'light', DARK = 'dark';

    function resolveTheme() {
        return localStorage.getItem('theme') ||
            (window.matchMedia('(prefers-color-scheme: dark)').matches ? DARK : LIGHT);
    }

    function applyT(theme) {
        document.documentElement.setAttribute('data-theme', theme);
        document.querySelectorAll('.theme-toggle').forEach(btn => {
            btn.textContent = theme === DARK ? 'â˜€ï¸' : 'ğŸŒ™';
            btn.setAttribute('aria-label', theme === DARK ? 'Switch to light mode' : 'Switch to dark mode');
        });
    }

    applyT(resolveTheme());

    document.body.addEventListener('click', e => {
        if (!e.target.closest('.theme-toggle')) return;
        const current = document.documentElement.getAttribute('data-theme') || resolveTheme();
        const next = current === DARK ? LIGHT : DARK;
        localStorage.setItem('theme', next);
        applyT(next);
        // sync radio
        const r = document.querySelector(`input[name="theme"][value="${next}"]`);
        if (r) r.checked = true;
    });

    window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', e => {
        if (!localStorage.getItem('theme')) applyT(e.matches ? DARK : LIGHT);
    });
})();

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   PURGING
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */

async function purgeOfflineCache() {
    const btn = document.getElementById('btnPurgeCache');
    if (!confirm('Purge all PWA offline cache?\n\nThis removes cached files (scripts, styles, pages) but your tracker data (IndexedDB) will NOT be affected.\n\nThe app will re-cache files automatically on next load.')) return;
    btn.disabled = true;
    btn.textContent = 'â³ Purgingâ€¦';
    try {
        if ('caches' in window) {
            const keys = await caches.keys();
            await Promise.all(keys.map(k => caches.delete(k)));
        }
        // âœ… Do NOT unregister the Service Worker â€” unregistering it would
        //    prevent the PWA from serving cached pages (including template.html)
        //    and break offline functionality until the next full page reload.
        //    The SW will automatically re-populate the cache on next navigation.
        showToast('Offline cache purged âœ“');
    } catch (err) {
        console.error(err);
        showToast('Error purging cache');
    } finally {
        btn.disabled = false;
        btn.innerHTML = 'ğŸ—‘ï¸ Purge Offline Cache';
    }
}

async function purgeIndexedDB() {
    const btn = document.getElementById('btnPurgeIDB');
    if (!confirm('âš ï¸ WARNING: This will permanently delete ALL tracker data stored in IndexedDB.\n\nThis includes every tracker and every entry you have logged.\nThe Quick Start Templates themselves will remain, but any trackers you created from them will be gone.\n\nExport a backup first if you want to keep your data.\n\nThis CANNOT be undone. Continue?')) return;
    btn.disabled = true;
    btn.textContent = 'â³ Purgingâ€¦';
    try {
        const dbs = await indexedDB.databases();
        await Promise.all(dbs.map(db => new Promise((resolve, reject) => {
            const req = indexedDB.deleteDatabase(db.name);
            req.onsuccess = resolve;
            req.onerror   = () => reject(req.error);
            req.onblocked = resolve; // proceed even if blocked
        })));
        showToast('IndexedDB purged âœ“');
    } catch (err) {
        console.error(err);
        showToast('Error purging IndexedDB');
    } finally {
        btn.disabled = false;
        btn.innerHTML = 'ğŸ—‘ï¸ Purge IndexedDB';
    }
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   BOOT
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
initThemeRadios();
initFontSize();
initLanguage();
populateTimezones();
</script>
  <script>
    // Register Service Worker
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('sw.js')
          .then(() => console.log("Service Worker Registered"))
          .catch(err => console.log("SW failed:", err));
      });
    }
  </script>

</body>
</html>