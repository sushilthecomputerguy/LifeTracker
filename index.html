<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Day</title>
    <link rel="stylesheet" href="styles.css">
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#fef5eb">
    <link rel="icon" href="favicon.ico" type="image/x-icon">
</head>
<body>
    <div class="container">
        <div style="display: grid;  grid-template-columns: 1fr 60px;align-items: center;"> 
        <h1  id="currentDateDisplay"></h1>

        <div class="date-wrapper">
          <!-- Hidden native input used only for value binding -->
          <input type="date" id="dateInput" onchange="changeDate()" style="display:none;" />
          <span class="calendar-icon" onclick="toggleCustomCalendar()">üìÖ</span>

          <!-- Custom Calendar Popup -->
          <div class="custom-calendar" id="customCalendar">
            <div class="cal-header">
              <button class="cal-nav" onclick="calNavMonth(-1)">&#8249;</button>
              <span class="cal-month-label" id="calMonthLabel"></span>
              <button class="cal-nav" onclick="calNavMonth(1)">&#8250;</button>
            </div>
            <div class="cal-weekdays">
              <span>Su</span><span>Mo</span><span>Tu</span><span>We</span><span>Th</span><span>Fr</span><span>Sa</span>
            </div>
            <div class="cal-days" id="calDays"></div>
          </div>
        </div>
        </div>

        <div class="date-selector" style="display: none;">
            <div class="date-controls">
                <button class="nav-btn" onclick="goToPreviousDay()">‚Üê Previous Day</button>
                <button class="nav-btn" onclick="goToToday()" id="todayBtn">Today</button>
                <label for="dateInput">Select Date:</label>
                <input type="date" id="dateInput" onchange="changeDate()">
            </div>
            <div class="current-date-display" id="currentDateDisplay"></div>
            
            <div class="week-navigation">
                <div class="week-dates" id="weekDates"></div>
            </div>
        </div>
        
        <div id="trackerList"></div>

        <div class="save-button-container">
            <button class="btn-save" onclick="saveAllTrackers()">üíæ Save Today's Entries</button>
            <div class="save-status" id="saveStatus"></div>
        </div>

        <!-- Toast Notification -->
        <div class="toast" id="toastNotification">
            <div class="toast-icon">
                <svg viewBox="0 0 16 16"><polyline points="2 8 6 12 14 4"/></svg>
            </div>
            <span id="toastMessage">Saved successfully!</span>
        </div>



    </div>
    <div class="bottom-navigation">
            <div><a href="trackers.html"><img src="folder-icon.svg"/><br/>Tracker</a></div>
            <div><a href="report.html"><img src="report-icon.svg"/><br/>Report</a></div>
            <div><a href="index.html"><img src="today-icon.svg"/><br/>My Day</a></div>
            <div><a href="settings.html"><img src="setting-icon.svg"/><br/>Settings</a></div>
        </div>
<style>
.date-wrapper {
  position: relative;
  display: inline-block;
}

.calendar-icon {
  font-size: 22px;
  cursor: pointer;
  background: var(--bg-card);
  padding: 8px;
  border-radius: 50px;
  display: inline-block;
  user-select: none;
}

/* Custom Calendar Popup */
.custom-calendar {
  display: none;
  position: absolute;
  top: calc(100% + 8px);
  right: 0;
  z-index: 999;
  background: var(--bg-card, #fff);
  border-radius: 16px;
  box-shadow: 0 8px 32px rgba(0,0,0,0.18);
  padding: 14px;
  min-width: 260px;
  animation: calPop .15s ease;
}
.custom-calendar.open { display: block; }

@keyframes calPop {
  from { opacity: 0; transform: scale(.95) translateY(-4px); }
  to   { opacity: 1; transform: scale(1) translateY(0); }
}

.cal-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  margin-bottom: 10px;
}

.cal-month-label {
  font-weight: 700;
  font-size: 14px;
  color: var(--text-primary, #333);
}

.cal-nav {
  background: none;
  border: none;
  font-size: 22px;
  cursor: pointer;
  color: var(--text-primary, #555);
  line-height: 1;
  padding: 0 6px;
  border-radius: 8px;
}
.cal-nav:hover { background: var(--bg-hover, #f0f0f0); }

.cal-weekdays {
  display: grid;
  grid-template-columns: repeat(7, 1fr);
  text-align: center;
  font-size: 11px;
  font-weight: 600;
  color: var(--text-secondary, #999);
  margin-bottom: 6px;
}

.cal-days {
  display: grid;
  grid-template-columns: repeat(7, 1fr);
  gap: 2px;
  text-align: center;
}

.cal-day {
  padding: 6px 2px;
  border-radius: 8px;
  font-size: 13px;
  cursor: pointer;
  transition: background .12s;
  border:1px solid var(--border);
}
.cal-day:hover:not(.cal-empty):not(.cal-disabled) { background: var(--bg-hover, #f0f0f0); }
.cal-day.cal-empty { cursor: default; }
.cal-day.cal-disabled { color: var(--text-primary, #333); cursor: default; pointer-events: none; }
.cal-day.cal-today { font-weight: 700; color: var(--accent, #e07b39); }
.cal-day.cal-selected {
  background: var(--accent, #e07b39);
  color: #fff !important;
  font-weight: 700;
}
</style>
    <script>
        // IndexedDB Setup
        let db;
        const DB_NAME = 'TrackerDB';
        const STORE_NAME = 'trackers';
        
        // Helper function to get local date string in YYYY-MM-DD format
        function getLocalDateString(date = new Date()) {
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }
        
        let currentDate = getLocalDateString(); // Current selected date
        
        // Temporary storage for current edits (before save)
        let tempSelections = {};

        // Initialize IndexedDB
        function initDB() {
            const request = indexedDB.open(DB_NAME, 2); // Match version from tracker-manager

            request.onerror = () => {
                console.error('Database failed to open');
            };

            request.onsuccess = () => {
                db = request.result;
                initializeDatePicker();
                loadTrackers();
            };

            request.onupgradeneeded = (e) => {
                db = e.target.result;
                
                if (!db.objectStoreNames.contains(STORE_NAME)) {
                    const objectStore = db.createObjectStore(STORE_NAME, { keyPath: 'id', autoIncrement: true });
                    objectStore.createIndex('title', 'title', { unique: false });
                }
            };
        }

        // Initialize date picker with current date and max date restriction
        function initializeDatePicker() {
            const dateInput = document.getElementById('dateInput');
            const today = getLocalDateString();
            
            // Set default value to today
            dateInput.value = currentDate;
            
            // Set max date to today (prevent future dates)
            dateInput.max = today;
            
            // Update display
            updateDateDisplay();
            renderWeekNavigation();
        }

        // Render week navigation with past 7 days
        function renderWeekNavigation() {
            const weekDates = document.getElementById('weekDates');
            const today = new Date();
            const dates = [];
            
            // Generate last 7 days (including today)
            for (let i = 6; i >= 0; i--) {
                const date = new Date(today);
                date.setDate(date.getDate() - i);
                dates.push(date);
            }
            
            weekDates.innerHTML = dates.map(date => {
                const dateStr = getLocalDateString(date);
                const dayName = date.toLocaleDateString('en-US', { weekday: 'short' });
                const dayNumber = date.getDate();
                const monthName = date.toLocaleDateString('en-US', { month: 'short' });
                const todayStr = getLocalDateString();
                
                const isActive = dateStr === currentDate;
                const isToday = dateStr === todayStr;
                
                let classes = 'date-item';
                if (isActive) classes += ' active';
                if (isToday) classes += ' today';
                
                return `
                    <div class="${classes}" onclick="selectWeekDate('${dateStr}')">
                        <div class="date-day">${dayName}</div>
                        <div class="date-number">${dayNumber}</div>
                        <div class="date-month">${monthName}</div>
                    </div>
                `;
            }).join('');
        }

        // Select date from week navigation
        function selectWeekDate(dateStr) {
            currentDate = dateStr;
            document.getElementById('dateInput').value = currentDate;
            updateDateDisplay();
            renderWeekNavigation();
            loadSelectionsForDate();
        }

        // Update the date display text
        function updateDateDisplay() {
            const dateObj = new Date(currentDate + 'T00:00:00');
            const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
            const formattedDate = dateObj.toLocaleDateString('en-US', options);
            
            const today = getLocalDateString();
            let displayText = formattedDate;
            
            if (currentDate === today) {
                displayText += ' (Today)';
            } else {
                const diffTime = new Date(today) - new Date(currentDate);
                const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                displayText += ` (${diffDays} day${diffDays !== 1 ? 's' : ''} ago)`;
            }
            
            document.getElementById('currentDateDisplay').textContent = displayText;
            
            // Update Today button state
            updateTodayButtonState();
            
            // Update week navigation highlight
            renderWeekNavigation();
        }

        // Update Today button state (disable if already on today)
        function updateTodayButtonState() {
            const todayBtn = document.getElementById('todayBtn');
            const today = getLocalDateString();
            
            if (currentDate === today) {
                todayBtn.disabled = true;
            } else {
                todayBtn.disabled = false;
            }
        }

        // Go to previous day
        function goToPreviousDay() {
            const dateObj = new Date(currentDate + 'T00:00:00');
            dateObj.setDate(dateObj.getDate() - 1);
            
            const previousDate = getLocalDateString(dateObj);
            currentDate = previousDate;
            
            // Update date input
            document.getElementById('dateInput').value = currentDate;
            
            updateDateDisplay();
            loadSelectionsForDate();
        }

        // Go to today
        function goToToday() {
            const today = getLocalDateString();
            currentDate = today;
            
            // Update date input
            document.getElementById('dateInput').value = currentDate;
            
            updateDateDisplay();
            loadSelectionsForDate();
        }

        // Handle date change
        function changeDate() {
            const dateInput = document.getElementById('dateInput');
            const selectedDate = dateInput.value;
            
            if (!selectedDate) return;
            
            // Validate that selected date is not in the future
            const today = getLocalDateString();
            if (selectedDate > today) {
                alert('Cannot select future dates');
                dateInput.value = currentDate;
                return;
            }
            
            currentDate = selectedDate;
            updateDateDisplay();
            loadSelectionsForDate();
        }

        // Get all trackers from DB
        function getAllTrackers() {
            return new Promise((resolve, reject) => {
                const transaction = db.transaction([STORE_NAME], 'readonly');
                const objectStore = transaction.objectStore(STORE_NAME);
                const request = objectStore.getAll();

                request.onsuccess = () => resolve(request.result);
                request.onerror = () => reject(request.error);
            });
        }

        // Get type label
        function getTypeLabel(type) {
            const labels = {
                'dropdown': 'Dropdown',
                'yesno': 'Yes/No',
                'numeric': 'Numeric',
                'text': 'Text'
            };
            return labels[type] || 'Dropdown';
        }

        // Load and display trackers
        async function loadTrackers() {
            const trackers = await getAllTrackers();
            const trackerList = document.getElementById('trackerList');

            if (trackers.length === 0) {
                trackerList.innerHTML = `
                    <div class="empty-state">
                        <p>No trackers available. Please create trackers first.</p>
                    </div>
                `;
                return;
            }

            trackerList.innerHTML = trackers.map(tracker => {
                const type = tracker.type || 'dropdown';
                return `
                    <div class="tracker-item">
                        <div class="tracker-header">
                            <div>
                                <span class="tracker-title">${tracker.title}</span>
                                <span class="tracker-type-badge">${getTypeLabel(type)}</span>
                            </div>
                        </div>
                        ${renderTrackerInput(tracker)}
                    </div>
                `;
            }).join('');

            // Load selections for current date
            loadSelectionsForDate();
        }

        // Render appropriate input based on tracker type
        function renderTrackerInput(tracker) {
            const type = tracker.type || 'dropdown';
            
            switch(type) {
                case 'dropdown':
                    const displayStyle = tracker.displayStyle || 'radio';
                    
                    if (displayStyle === 'radio') {
                        // Radio buttons style
                        return `
                            <div class="radio-options" id="tracker-${tracker.id}-container">
                                ${tracker.options.map((option, index) => `
                                    <div class="radio-option" 
                                         style="background-color: ${option.color}"
                                         data-tracker-id="${tracker.id}"
                                         data-value="${index}"
                                         data-type="dropdown"
                                         onclick="handleRadioSelection(${tracker.id}, ${index}, '${option.color}')">
                                        ${option.title}
                                    </div>
                                `).join('')}
                            </div>
                        `;
                    } else if (displayStyle === 'slider') {
                        // Slider style
                        return `
                            <div class="slider-container">
                                <div class="slider-label" id="slider-label-${tracker.id}">
                                    Select an option
                                </div>
                                <div class="slider-wrapper">
                                    <input type="range" 
                                           class="slider-input" 
                                           id="slider-${tracker.id}"
                                           min="0" 
                                           max="${tracker.options.length - 1}" 
                                           value=""
                                           data-tracker-id="${tracker.id}"
                                           data-type="dropdown"
                                           oninput="handleSliderChange(${tracker.id}, this.value)"
                                           onchange="handleSliderChange(${tracker.id}, this.value)"
                                           style="background: linear-gradient(to right, ${tracker.options.map(o => o.color).join(', ')})">
                                </div>
                                <div class="slider-marks">
                                    ${tracker.options.map((option, index) => {
                                        if (index === 0 || index === tracker.options.length - 1) {
                                            return `<div class="slider-mark">${option.title}</div>`;
                                        } else if (tracker.options.length <= 5) {
                                            return `<div class="slider-mark">${option.title}</div>`;
                                        } else {
                                            return `<div class="slider-mark"></div>`;
                                        }
                                    }).join('')}
                                </div>
                            </div>
                        `;
                    } else {
                        // Dropdown style (default)
                        return `
                            <select id="tracker-${tracker.id}" class="tracker-input dropdown-select" data-tracker-id="${tracker.id}" data-type="dropdown">
                                <option value="">Select an option</option>
                                ${tracker.options.map((option, index) => `
                                    <option value="${index}" data-color="${option.color}">
                                        ${option.title}
                                    </option>
                                `).join('')}
                            </select>
                        `;
                    }
                
                case 'yesno':
                    return `
                        <div class="yesno-buttons">
                            <button class="yesno-btn" id="tracker-${tracker.id}-yes" onclick="handleYesNoChange(${tracker.id}, 'yes')">
                                Yes
                            </button>
                            <button class="yesno-btn" id="tracker-${tracker.id}-no" onclick="handleYesNoChange(${tracker.id}, 'no')">
                                No
                            </button>
                        </div>
                    `;
                
                case 'numeric':
                    const prefix = tracker.numericPrefix || '';
                    const suffix = tracker.numericSuffix || '';
                    return `
                        <div class="numeric-input-group">
                            ${prefix ? `<span class="numeric-prefix">${prefix}</span>` : ''}
                            <input 
                                type="number" 
                                id="tracker-${tracker.id}" 
                                class="numeric-input" 
                                placeholder="Enter number"
                                step="any"
                                data-tracker-id="${tracker.id}" 
                                data-type="${type}"
                            >
                            ${suffix ? `<span class="numeric-suffix">${suffix}</span>` : ''}
                        </div>
                    `;
                
                case 'text':
                    return `
                        <textarea 
                            id="tracker-${tracker.id}" 
                            class="tracker-input" 
                            placeholder="Write your note here..."
                            data-tracker-id="${tracker.id}" 
                            data-type="${type}"
                        ></textarea>
                    `;
                
                default:
                    return '<p>Unknown tracker type</p>';
            }
        }

        // Handle yes/no button click
        function handleYesNoChange(trackerId, value) {
            const yesBtn = document.getElementById(`tracker-${trackerId}-yes`);
            const noBtn = document.getElementById(`tracker-${trackerId}-no`);
            
            // Remove all selected classes
            yesBtn.classList.remove('selected-yes', 'selected-no');
            noBtn.classList.remove('selected-yes', 'selected-no');
            
            // Add appropriate class
            if (value === 'yes') {
                yesBtn.classList.add('selected-yes');
            } else {
                noBtn.classList.add('selected-no');
            }
            
            // Store temporarily (don't save yet)
            if (!tempSelections[currentDate]) {
                tempSelections[currentDate] = {};
            }
            tempSelections[currentDate][trackerId] = {
                trackerId: trackerId,
                value: value,
                type: 'yesno',
                date: currentDate
            };
        }

        // Handle radio button selection
        function handleRadioSelection(trackerId, optionIndex, color) {
            // Remove 'selected' class from all options in this tracker
            const container = document.getElementById(`tracker-${trackerId}-container`);
            container.querySelectorAll('.radio-option').forEach(option => {
                option.classList.remove('selected');
            });
            
            // Add 'selected' class to clicked option
            const selectedOption = container.querySelector(`[data-value="${optionIndex}"]`);
            if (selectedOption) {
                selectedOption.classList.add('selected');
            }
            
            // Store temporarily (don't save yet)
            if (!tempSelections[currentDate]) {
                tempSelections[currentDate] = {};
            }
            tempSelections[currentDate][trackerId] = {
                trackerId: trackerId,
                value: String(optionIndex),
                type: 'dropdown',
                date: currentDate
            };
        }

        // Handle slider change
        function handleSliderChange(trackerId, value) {
            // Get tracker data to find option info
            getAllTrackers().then(trackers => {
                const tracker = trackers.find(t => t.id === trackerId);
                if (tracker && tracker.options && tracker.options[value]) {
                    const option = tracker.options[value];
                    const label = document.getElementById(`slider-label-${trackerId}`);
                    if (label) {
                        label.textContent = option.title;
                        label.style.color = option.color;
                    }
                    
                    // Store temporarily (don't save yet)
                    if (!tempSelections[currentDate]) {
                        tempSelections[currentDate] = {};
                    }
                    tempSelections[currentDate][trackerId] = {
                        trackerId: trackerId,
                        value: String(value),
                        type: 'dropdown',
                        date: currentDate
                    };
                }
            });
        }

        // Save all trackers for the current date
        function saveAllTrackers() {
            // Collect all current values from inputs
            const currentSelections = {};
            
            // Get all dropdown values
            document.querySelectorAll('select[data-tracker-id]').forEach(select => {
                const trackerId = select.getAttribute('data-tracker-id');
                const value = select.value;
                const type = select.getAttribute('data-type');
                
                if (value) {
                    currentSelections[trackerId] = {
                        trackerId: parseInt(trackerId),
                        value: value,
                        type: type,
                        date: currentDate,
                        timestamp: new Date().toISOString()
                    };
                }
            });
            
            // Get all numeric and text inputs
            document.querySelectorAll('input[data-tracker-id], textarea[data-tracker-id]').forEach(input => {
                const trackerId = input.getAttribute('data-tracker-id');
                const value = input.value.trim();
                const type = input.getAttribute('data-type');
                
                if (value) {
                    currentSelections[trackerId] = {
                        trackerId: parseInt(trackerId),
                        value: value,
                        type: type,
                        date: currentDate,
                        timestamp: new Date().toISOString()
                    };
                }
            });
            
            // Merge with yes/no selections from tempSelections
            if (tempSelections[currentDate]) {
                Object.keys(tempSelections[currentDate]).forEach(trackerId => {
                    const selection = tempSelections[currentDate][trackerId];
                    selection.timestamp = new Date().toISOString();
                    currentSelections[trackerId] = selection;
                });
            }
            
            // Save to localStorage
            let dailySelections = JSON.parse(localStorage.getItem('dailySelections') || '{}');
            
            if (Object.keys(currentSelections).length > 0) {
                dailySelections[currentDate] = currentSelections;
            } else {
                // If no selections, remove this date
                delete dailySelections[currentDate];
            }
            
            localStorage.setItem('dailySelections', JSON.stringify(dailySelections));
            
            // Clear temp selections for this date
            if (tempSelections[currentDate]) {
                delete tempSelections[currentDate];
            }
            
            // Show toast notification
            showToast('Saved successfully!');
            
            console.log('Saved selections for', currentDate, currentSelections);
        }

        // Load selections for the currently selected date
        async function loadSelectionsForDate() {
            const dailySelections = JSON.parse(localStorage.getItem('dailySelections') || '{}');
            const dateSelections = dailySelections[currentDate] || {};

            // Clear temp selections when changing dates
            tempSelections = {};

            // First, reset all inputs to default
            document.querySelectorAll('[id^="tracker-"]').forEach(element => {
                if (element.tagName === 'SELECT') {
                    element.value = '';
                    element.style.borderLeft = '1px solid #ddd';
                } else if (element.tagName === 'INPUT' && element.type !== 'range') {
                    element.value = '';
                } else if (element.tagName === 'TEXTAREA') {
                    element.value = '';
                } else if (element.classList.contains('yesno-btn')) {
                    element.classList.remove('selected-yes', 'selected-no');
                } else if (element.classList.contains('radio-option')) {
                    element.classList.remove('selected');
                }
            });

            // Reset slider labels
            document.querySelectorAll('[id^="slider-label-"]').forEach(label => {
                label.textContent = 'Select an option';
                label.style.color = '';
            });

            // Get all trackers to know their display styles
            const trackers = await getAllTrackers();

            // Then load selections for this date
            Object.keys(dateSelections).forEach(trackerId => {
                const selection = dateSelections[trackerId];
                const type = selection.type || 'dropdown';
                const tracker = trackers.find(t => t.id == trackerId);
                
                if (type === 'dropdown' && tracker) {
                    const displayStyle = tracker.displayStyle || 'radio';
                    
                    if (displayStyle === 'radio') {
                        // Handle radio button selection
                        const container = document.getElementById(`tracker-${trackerId}-container`);
                        if (container) {
                            const selectedOption = container.querySelector(`[data-value="${selection.value}"]`);
                            if (selectedOption) {
                                selectedOption.classList.add('selected');
                            }
                        }
                    } else if (displayStyle === 'slider') {
                        // Handle slider selection
                        const slider = document.getElementById(`slider-${trackerId}`);
                        if (slider) {
                            slider.value = selection.value;
                            // Update label
                            const option = tracker.options[parseInt(selection.value)];
                            if (option) {
                                const label = document.getElementById(`slider-label-${trackerId}`);
                                if (label) {
                                    label.textContent = option.title;
                                    label.style.color = option.color;
                                }
                            }
                        }
                    } else {
                        // Handle dropdown selection
                        const select = document.getElementById(`tracker-${trackerId}`);
                        if (select) {
                            select.value = selection.value;
                            
                            // Apply color indicator
                            const selectedOption = select.options[select.selectedIndex];
                            const color = selectedOption?.getAttribute('data-color');
                            if (color) {
                                select.style.borderLeft = `4px solid ${color}`;
                            }
                        }
                    }
                } else if (type === 'yesno') {
                    const yesBtn = document.getElementById(`tracker-${trackerId}-yes`);
                    const noBtn = document.getElementById(`tracker-${trackerId}-no`);
                    if (yesBtn && noBtn) {
                        if (selection.value === 'yes') {
                            yesBtn.classList.add('selected-yes');
                        } else {
                            noBtn.classList.add('selected-no');
                        }
                    }
                } else if (type === 'numeric' || type === 'text') {
                    const input = document.getElementById(`tracker-${trackerId}`);
                    if (input) {
                        input.value = selection.value;
                    }
                }
            });

            // Clear save status when changing dates
            const statusEl = document.getElementById('saveStatus');
            statusEl.textContent = '';
            statusEl.className = 'save-status';
        }

        // Toast notification helper
        let toastTimer = null;
        function showToast(message) {
            const toast = document.getElementById('toastNotification');
            const toastMsg = document.getElementById('toastMessage');
            toastMsg.textContent = message;

            // Clear any running timer so rapid saves don't stack
            if (toastTimer) clearTimeout(toastTimer);

            toast.classList.add('show');
            toastTimer = setTimeout(() => {
                toast.classList.remove('show');
                toastTimer = null;
            }, 3000);
        }

        // Initialize app
        initDB();
    </script>




    <script>
        /**
 * theme.js  ‚Äî  drop this into every page
 *
 * What it does:
 *  1. On load: reads saved preference from localStorage.
 *              Falls back to OS preference (prefers-color-scheme).
 *              Applies data-theme to <html> BEFORE paint (no flash).
 *  2. Toggle:  clicking .theme-toggle cycles light ‚Üî dark and saves choice.
 *  3. Sync:    listens for OS-level changes in case the user switches in
 *              system settings and has no manual preference saved.
 */

(function () {
  const STORAGE_KEY = 'theme';
  const LIGHT = 'light';
  const DARK  = 'dark';

  // ‚îÄ‚îÄ 1. Resolve theme ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  function getSystemTheme() {
    return window.matchMedia('(prefers-color-scheme: dark)').matches ? DARK : LIGHT;
  }

  function getSavedTheme() {
    return localStorage.getItem(STORAGE_KEY); // null if never set
  }

  function resolveTheme() {
    return getSavedTheme() || getSystemTheme();
  }

  // ‚îÄ‚îÄ 2. Apply theme ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  function applyTheme(theme) {
    document.documentElement.setAttribute('data-theme', theme);
    // Update every toggle button icon on the page
    document.querySelectorAll('.theme-toggle').forEach(btn => {
      btn.textContent = theme === DARK ? '‚òÄÔ∏è' : 'üåô';
      btn.setAttribute('aria-label', theme === DARK ? 'Switch to light mode' : 'Switch to dark mode');
    });
  }

  // ‚îÄ‚îÄ 3. Toggle ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  function toggleTheme() {
    const current = document.documentElement.getAttribute('data-theme') || resolveTheme();
    const next    = current === DARK ? LIGHT : DARK;
    localStorage.setItem(STORAGE_KEY, next);
    applyTheme(next);
  }

  // ‚îÄ‚îÄ 4. Wire up toggle buttons (works for buttons added later too) ‚îÄ‚îÄ
  //    We use event delegation on <body> so it works even if the button
  //    is injected by JS after DOMContentLoaded.
  function attachToggle() {
    document.body.addEventListener('click', function (e) {
      if (e.target.closest('.theme-toggle')) toggleTheme();
    });
  }

  // ‚îÄ‚îÄ 5. Sync with OS changes (only if user has no saved pref) ‚îÄ‚îÄ
  function watchSystemTheme() {
    window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', function (e) {
      if (!getSavedTheme()) {
        applyTheme(e.matches ? DARK : LIGHT);
      }
    });
  }

  // ‚îÄ‚îÄ INIT ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  // Apply before first paint to avoid flash
  applyTheme(resolveTheme());

  // Wire up after DOM is ready
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', attachToggle);
  } else {
    attachToggle();
  }

  watchSystemTheme();
})();
</script>

  <script>
    // Register Service Worker
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('sw.js')
          .then(() => console.log("Service Worker Registered"))
          .catch(err => console.log("SW failed:", err));
      });
    }
  </script>
</body>
</html>
  <script>
    // ‚îÄ‚îÄ Custom Calendar Popup ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    let calViewYear, calViewMonth;

    function toggleCustomCalendar() {
      const cal = document.getElementById('customCalendar');
      if (cal.classList.contains('open')) {
        cal.classList.remove('open');
      } else {
        const parts = currentDate.split('-');
        calViewYear  = parseInt(parts[0]);
        calViewMonth = parseInt(parts[1]) - 1;
        renderCustomCalendar();
        cal.classList.add('open');
      }
    }

    document.addEventListener('click', function(e) {
      const wrapper = document.querySelector('.date-wrapper');
      if (wrapper && !wrapper.contains(e.target)) {
        document.getElementById('customCalendar').classList.remove('open');
      }
    });

    function calNavMonth(dir) {
      calViewMonth += dir;
      if (calViewMonth > 11) { calViewMonth = 0;  calViewYear++; }
      if (calViewMonth < 0)  { calViewMonth = 11; calViewYear--; }
      renderCustomCalendar();
    }

    function renderCustomCalendar() {
      const today = getLocalDateString();
      const label = document.getElementById('calMonthLabel');
      const grid  = document.getElementById('calDays');

      const monthNames = ['January','February','March','April','May','June',
                          'July','August','September','October','November','December'];
      label.textContent = monthNames[calViewMonth] + ' ' + calViewYear;

      const firstDay    = new Date(calViewYear, calViewMonth, 1).getDay();
      const daysInMonth = new Date(calViewYear, calViewMonth + 1, 0).getDate();

      let html = '';
      for (let i = 0; i < firstDay; i++) html += '<div class="cal-day cal-empty"></div>';
      for (let d = 1; d <= daysInMonth; d++) {
        const mm  = String(calViewMonth + 1).padStart(2,'0');
        const dd  = String(d).padStart(2,'0');
        const ds  = calViewYear + '-' + mm + '-' + dd;
        const isToday    = ds === today;
        const isSelected = ds === currentDate;
        const isFuture   = ds > today;
        let cls = 'cal-day';
        if (isToday)    cls += ' cal-today';
        if (isSelected) cls += ' cal-selected';
        if (isFuture)   cls += ' cal-disabled';
        html += '<div class="' + cls + '" onclick="calSelectDay(\'' + ds + '\')">' + d + '</div>';
      }
      grid.innerHTML = html;
    }

    function calSelectDay(dateStr) {
      currentDate = dateStr;
      document.getElementById('dateInput').value = dateStr;
      updateDateDisplay();
      renderWeekNavigation();
      loadSelectionsForDate();
      document.getElementById('customCalendar').classList.remove('open');
    }

    function openCalendar() { toggleCustomCalendar(); }
  </script>